import  json

from    extensionBackend.pythonScripts.clasificador import  urlClasificador
from    django.http                                 import  JsonResponse , HttpResponse
from    django.views.decorators.csrf                import  csrf_exempt
from    braces.views                                import  CsrfExemptMixin

from    rest_framework.response import  Response
from    rest_framework.views    import  APIView
from    rest_framework          import  status



def index(request):
    return  HttpResponse("Hola mundo.")

def urlGet(request):
    url =   request.GET.get('url',  None)

    print(f"url -> {url}")

    urlJson =   {
        "url":f"Esta es la prueba    {url}"
    }

    print(f"Datos JSON a enviar:    {urlJson}")

    return  JsonResponse(urlJson)

class   UrlPostApiView(CsrfExemptMixin, APIView):
    authentication_classes = []

    def get(self,   request):
        return  Response(status=status.HTTP_200_OK, data="Hola GET")

    @csrf_exempt
    def post(self,  request,    format= None):

        urlMaliciosos   =   []
        dataRecibida    =   json.loads(request.body.decode("utf-8"))
        # <class 'list'>
        # print(dataRecibida)
        # with    open("extensionBackend/pythonScripts/modeloPickle",    "rb") as f:
        #     clf             =   pickle.load(f)

        dataTemporal    =   {"urls":dataRecibida}
        urlLista        =   dataTemporal["urls"]
        urlLista        =   [url    for url   in  urlLista  if  (url !=  None) and (url!="javascript:void(0)")]
        print("---------------------------------------------------------------")
        print(f'URLs Totales:   {len(urlLista)}')
        print("---------------------------------------------------------------")
# --------------------------------------------------------------------------------------------------

        urlMaliciosos   =   list(set(list(urlClasificador(urlLista))))
        print("---------------------------------------------------------------")
        print(f'URLs Maliciosos (Malware):    {len(urlMaliciosos)}')
        print("---------------------------------------------------------------")
        
        dataEnviada =   urlMaliciosos
        dataEnviada =   json.dumps(dataEnviada)
        # print(dataEnviada)
        # return  Response(status=status.HTTP_200_OK, data=dataEnviada)
        return  JsonResponse(dataEnviada,   safe=False)